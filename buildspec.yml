version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 18  
      elixir: 1.14.3
      postgresql: 14.5  
      erlang: 24.0   

    commands:
      - sudo apt-get update
      - sudo apt-get install -y git
      - sudo apt-get install -y build-essential git wget libssl-dev libreadline-dev libncurses5-dev zlib1g-dev m4 curl wx-common libwxgtk3.0-dev autoconf
      - wget https://packages.erlang-solutions.com/erlang-solutions_1.0_all.deb && dpkg -i erlang-solutions_1.0_all.deb
      - sudo apt-get update
      - sudo apt-get install -y esl-erlang
      - sudo apt-get install -y elixir
      - mkdir ~/node-latest-install && cd $_ && \
      - curl --silent --location https://deb.nodesource.com/setup_10.x | bash -
      - sudo apt-get install -y nodejs
      - curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -;
      - echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list;
      - sudo apt-get update && apt-get install -y yarn;

      - cd backend
      - mix local.hex --force
      - mix local.rebar --force

      # Install dependencies for Phoenix (including PostgreSQL)
      - mix deps.get
      - mix compile

      # Install Node.js dependencies for React
      - cd assets/js/react
      - npm install

  pre_build:
    commands:
      # Set up the database (you might need to adjust this based on your needs)
      - cd ../..
      - mix ecto.create
      - mix ecto.migrate

  build:
    commands:
      # Build React
      - cd assets/js/react
      - npm run build

      # Build Phoenix
      - cd ../../backend
      - mix phx.digest

artifacts:
  files:
    - 'assets/js/react/build/**/*'
    - '_build/prod/rel/*/**/*'
    - 'config/prod.secret.exs'
    - 'priv/repo/migrations/**/*'

cache:
  paths:
    - 'assets/js/react/node_modules'
    - 'deps'
    - '_build'